import type { SpButtonProps } from "../types/button";
import type { ButtonVariant } from "@phcdevworks/spectre-ui";
import { getButtonClasses } from "@phcdevworks/spectre-ui";

type Props = SpButtonProps;

const props = Astro.props as Props;

const {
  variant = "primary",
  size = "md",
  as = "button",
  type: buttonType = "button",
  href,
  target,
  rel,
  disabled = false,
  loading = false,
  fullWidth = false,
  class: className,
  ...rest
} = props;

const normalizedVariant: ButtonVariant =
  variant === "success" ? "primary" : variant;
const isInteractiveDisabled = disabled || loading;

const generatedClasses = getButtonClasses({
  variant: normalizedVariant,
  size,
  fullWidth,
  loading,
  disabled: isInteractiveDisabled,
});

const classTokens = generatedClasses.split(" ").filter(Boolean);
const spectreClasses =
  variant === "success"
    ? classTokens.filter((token) => token !== "sp-btn--primary").concat("sp-btn--success")
    : classTokens;
const classes = [...spectreClasses, className].filter(Boolean).join(" ");

const relValue =
  target === "_blank" ? rel ?? "noopener noreferrer" : rel ?? undefined;

const sharedProps = {
  ...rest,
  class: classes,
  "aria-busy": loading ? "true" : undefined,
  "data-loading": loading ? "true" : undefined,
};

const anchorProps =
  as === "a"
    ? {
        ...sharedProps,
        href: isInteractiveDisabled ? undefined : href,
        target: isInteractiveDisabled ? undefined : target,
        rel: isInteractiveDisabled ? undefined : relValue,
        "aria-disabled": isInteractiveDisabled ? "true" : sharedProps["aria-disabled"],
      }
    : null;

const spanProps =
  as === "span"
    ? {
        ...sharedProps,
        role: sharedProps.role ?? "button",
        "aria-disabled": isInteractiveDisabled ? "true" : sharedProps["aria-disabled"],
      }
    : null;

const buttonProps =
  as === "button" || !["a", "span"].includes(as)
    ? {
        ...sharedProps,
        type: buttonType,
        disabled: isInteractiveDisabled,
      }
    : null;
---

{
  as === "a" ? (
    <a {...anchorProps}>
      <slot />
    </a>
  ) : as === "span" ? (
    <span {...spanProps}>
      <slot />
    </span>
  ) : (
    <button {...buttonProps}>
      <slot />
    </button>
  )
}
