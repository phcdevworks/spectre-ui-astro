---
import type { SpInputProps, SpInputState } from "../types/input.ts";
import { getInputClasses } from "@phcdevworks/spectre-ui";

type Props = SpInputProps;

const generateInputId = () =>
  `sp-input-${
    globalThis.crypto?.randomUUID?.() ??
    Math.random().toString(36).slice(2, 10)
  }`;

const props = Astro.props as Props;

const {
  state: providedState = "default",
  type = "text",
  label,
  errorMessage,
  helperText,
  id: providedId,
  class: className,
  required = false,
  disabled: disabledProp = false,
  "aria-describedby": ariaDescribedby,
  "aria-invalid": ariaInvalid,
  "aria-disabled": ariaDisabled,
  ...rest
} = props;

const computedState: SpInputState =
  disabledProp || providedState === "disabled"
    ? "disabled"
    : providedState;

const inputId = providedId ?? generateInputId();

const showError = Boolean(errorMessage && computedState === "invalid");
const showHelperText = Boolean(helperText && !showError);

const helperTextId = showHelperText ? `${inputId}-helper` : undefined;
const errorTextId = showError ? `${inputId}-error` : undefined;

const describedBy =
  [ariaDescribedby, helperTextId, errorTextId].filter(Boolean).join(" ") ||
  undefined;

const recipeState =
  computedState === "invalid"
    ? "error"
    : computedState === "valid"
      ? "success"
      : "default";

const additionalStateClasses: Partial<Record<SpInputState, string>> = {
  focus: "sp-input--focus",
  disabled: "sp-input--disabled",
};

const baseClasses = getInputClasses({
  state: recipeState,
});

const classes = [
  baseClasses,
  additionalStateClasses[computedState],
  className,
]
  .filter(Boolean)
  .join(" ");

const inputProps = {
  ...rest,
  type,
  id: inputId,
  required,
  class: classes,
  disabled: computedState === "disabled" ? true : disabledProp,
  "aria-describedby": describedBy,
  "aria-invalid": ariaInvalid ?? (showError ? true : undefined),
  "aria-disabled":
    ariaDisabled ?? (computedState === "disabled" ? true : undefined),
};
---

<div class="sp-input-wrapper">
  {label && (
    <label for={inputId} class="sp-label">
      {label}
      {required && <span class="sp-required" aria-label="required">*</span>}
    </label>
  )}

  <input {...inputProps} />

  {showError && (
    <div id={errorTextId} class="sp-error-message" role="alert">
      {errorMessage}
    </div>
  )}

  {showHelperText && (
    <div id={helperTextId} class="sp-helper-text">
      {helperText}
    </div>
  )}
</div>
